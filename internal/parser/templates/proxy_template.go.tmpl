// Code generated by simple-gen-proxy. DO NOT EDIT.
// source: {{.SourceFile}}

package {{.PackageName}}

import (
    "database/sql"

    {{range .Imports}}
    {{.Alias}} "{{.Path}}"
    {{end}}
)

{{range .Interfaces}}

type {{.ProxyTypeName}}Transaction func() *sql.DB

type {{.ProxyTypeName}} struct {
    target {{if .IsDiffrentPackage}}{{.InterfacePakcage}}.{{end}}{{.InterfaceName}}
    db {{.ProxyTypeName}}Transaction
}

func New{{.ProxyTypeName}}(target {{if .IsDiffrentPackage}}{{.InterfacePakcage}}.{{end}}{{.InterfaceName}}, db {{.ProxyTypeName}}Transaction) *{{.ProxyTypeName}} {
    return &{{.ProxyTypeName}}{
        target: target,
        db: db,
    }
}

{{range .Methods}}
func (p *{{.ProxyTypeName}}) {{.Name}}({{.Params}}) {{.Results}} {
    {{if .IsTransaction}}
        db := p.db()
        tx, txErr := db.Begin()
        if txErr != nil {
            panic(txErr)
        }
        
        {{if .HasResults}}{{.ResultVars}} := {{end}}p.target.{{.Name}}({{.ParamNames}})
        if err != nil {
            if txErr := tx.Rollback(); txErr != nil {
                panic(txErr)
            } 
        } else {
            if txErr := tx.Commit(); txErr != nil {
                panic(txErr)
            }
        }

        {{if .HasResults}}
            return {{.ResultVars}}
        {{end}}
    {{else}}
        {{if .HasResults}} return {{end}} p.target.{{.Name}}({{.ParamNames}})
    {{end}}
}
{{end}}
{{end}}